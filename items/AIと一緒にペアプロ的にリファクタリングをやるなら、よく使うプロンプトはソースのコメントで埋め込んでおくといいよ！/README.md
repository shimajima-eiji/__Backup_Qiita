:::note warn
AIの進化は目覚ましく、本稿も個人の感想であり、投稿時点での知見です。
:::

## はじめに

「ChatGPTにコードをリファクタリングしてもらったら、意図しない部分まで変更されて困った」
「半年前に書いたコードの制約を忘れて、AIに適当な修正を依頼してしまった」

そんな経験はありませんか？

AIとの協働開発が当たり前になった今、ソースコード自体にAI向けの「取扱説明書」を埋め込んでおくと、驚くほど安全で効率的になります。今回は実際に運用している手法をご紹介します。

## 問題：AIは空気を読まない

AIにコードのリファクタリングを依頼するとき、私たちは暗黙の前提を持っています：

- 「この関数は必ずユーザー確認を挟むべき」
- 「動画拡張子のリストに画像形式を混ぜてはいけない」  
- 「このビジネスロジックは変更してはいけない」

しかし、AIにはこれらの文脈は見えません。結果として、

```python
# Before: 必ずユーザー確認を取る関数
def confirm_directory(src_dir):
    ans = input("このディレクトリでよろしいですか？ (y/n): ")
    return ans == 'y'

# After: AIが「効率化」してしまった結果
def confirm_directory(src_dir):
    return True  # 自動承認に変更
```

のような修正を加えてしまうかもしれません。

このような「善意の改悪」を防ぐには、ソースファイル内にAI向けの指示を埋め込むのが効果的です。

## 解決策：ソースファイル埋め込み型プロンプト

:::note
ここからはAIの力も借りて記事を書いています。
特に検証のため様々なサービスを活用し、結果を確認しています。
:::

:::note alert
- 悪用するとプロンプトインジェクションになりえるため、軽い気持ちでやってはいけません。
- 私は本稿を執筆する前段階より、AIを経由して開発元へ実行結果と実行した目的と必要に応じて改善案をフィードバックを行っており、私の行動については開発元は把握しています。
:::

### 基本形：シンプルな保護

```python
# ⚠️ 【変更ルール】prompt.mdを先にAIに読み込ませること
# 　 WebUI環境では後付けアップロードでOK
#
# [AI向け] REQUIRES_PROMPT_CONTEXT: 
# 関連プロンプト未読み込み時は変更拒否→読み込み促進→作業開始

def important_function():
    # 実際のコード
    pass
```

### 発展形：ビジネスロジック保護

```python
# ==================== リファクタリング保護領域 開始 ====================
# REQUIRES_REFACTOR_PROMPT: ./prompt.md
# 
# 【AIへの指示】
# - confirm_directory関数は必ずユーザー確認を挟むこと。自動化しないこと。
# - movie_extsは動画拡張子のみを記載し、画像や音声拡張子を混入させないこと。
# - ファイル移動時は同名ファイルの上書きを絶対に避けること（リネーム必須）。
# 
# ==================== リファクタリング保護領域 終了 ====================

def confirm_directory(src_dir):
    """この確認処理は必ず残すこと。自動化しないこと。"""
    ans = input("このディレクトリでよろしいですか？ (y/n): ")
    return ans == 'y'
```

prompt.mdの内容は省略（プロジェクト固有のAI運用ルールのため）

## 実際の効果

### Before：プロンプト埋め込み前
```
人間：「このコードをリファクタリングして」
AI：「効率化しました！確認処理を削除し、自動実行にしました」
人間：「それは困る...元に戻して」
```

### After：プロンプト埋め込み後
```
人間：「このコードをリファクタリングして」
AI：「ファイル保護を検出しました。関連するprompt.mdを先に読み込んでください」
人間：（prompt.mdアップロード）
AI：「制約を理解しました。確認処理は維持したまま、他の部分を改善します」
```

## 設計のポイント

### 1. 運用者に優しい設計

半年後の自分が見ても理解できるよう、**なぜその制約があるのか**を明記：

```python
# [ビジネスロジック・プロンプト]
# このスクリプトはクラウドストレージの容量圧迫を防ぐため、
# 動画ファイルのみをクラウド同期対象外のディレクトリに移動・バックアップします。
#
# 【重要な制約】
# - 保存先ディレクトリが存在しない場合は必ずエラーで停止すること。
# - 本スクリプトの目的外の自動削除や圧縮処理は絶対に追加しないこと。
```

### 2. AI固有の特性を考慮

AIモデルによって指示の理解度が異なるため、明示的に記載。
この内容に限ってはプロンプトというよりは人間に向けた注意喚起。

```python
# ⚠️ 注意：この保護機能を無視する可能性があります
# 　　　　 指定するAIモデルまたはサービスの使用を推奨
```

### 3. WebUI環境での実用性

実際の開発現場では、後からファイルをアップロードすることが多いため：

```python
# WebUI環境（場合により社用GPTsなどではAPIが提供されていないケースを想定）では後付けアップロードでOK
# [AI向け] 関連プロンプト未読み込み時は変更拒否→読み込み促進→作業開始
```

## 運用上の工夫

### レベル別保護

:::note warn
モデルやバージョンによって違いがありそう
:::

```python
# PROTECTION_LEVEL: CRITICAL    # 絶対変更禁止
# PROTECTION_LEVEL: STANDARD    # 確認必要  
# PROTECTION_LEVEL: ADVISORY    # 警告のみ
```

### 具体的な禁止事項を明記

```python
# 【絶対禁止】
# - 確認処理の自動化
# - 拡張子リストへの画像形式混入
# - 同名ファイルの上書き処理
```

## まとめ

ソースファイルへのプロンプト埋め込みは：

✅ **安全性向上**: 意図しない変更を防ぐ  
✅ **効率化**: 毎回制約を説明する手間が不要  
✅ **保守性**: 半年後の自分にも優しい  
✅ **チーム開発**: 暗黙知の共有

特に、ビジネスロジックが複雑なコードや、安全性が重要なスクリプトでは効果絶大です。

「AIは優秀だが、空気は読まない」という特性を理解し、適切な制約を事前に埋め込んでおく。これが、AIとの協働開発を成功させる秘訣だと思います。
