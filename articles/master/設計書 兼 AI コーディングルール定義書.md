# 設計書 兼 AI コーディングルール定義書

## ゴールデンルール

- コミュニケーションは日本語で行うこと。
- いかなる場合でも AI は本ファイルを変更してはならない。
- AI はここに定められたルールを厳守しなければならない。
- AI はタスクの実行が完了するたびにローカル git リポジトリに commit を行い、差し戻しを容易にできるようにすること
- 設計者は差し戻ししたいバージョンにタグ付けをしておくと良い。AI に依頼することもできる
- 完成版としてリモートリポジトリに push する場合、今回作業したコミット履歴は可能な限り圧縮すること
  - 差し戻しタグがついているバージョンのコミットは完成版とは別のコミットバージョンとして残しておくと良い
- 日付型を文字列で扱う場合は `yyyy-MM-dd HH:MM:SS` とする
  - リアルタイム性が必要ではない場合は `yyyy-MM-dd HH:MM` とする
- AI エージェントで実装した方が早いか、あるいはエンジニアが自力で実装した方が早いか判断をしたいため、AI は設計者の入力待ちモードに移行する時はタスクの開始から終了までのトータル時間を都度報告すること

## AI エージェントの定義

- 本項では AI または AI エージェントは「実装を主とするもの」と定義する（以下、実装 AI）
  - 特に文中で指定がない場合、AI とは実装 AI を指す。
- 実装 AI は本書の変更を厳禁とする
- 設計 AI は本書を元に実装 AI へ指示書プロンプトを書いて実行させるものとする
- 設計 AI は設計者との協議により本書の内容を変更することができる
- 設計 AI は本書のファイル名やファイル配置を変更することはできない

## 実行環境

- python を実行する場合は poetry を使うこと
- poetry が使えない場合は環境構築を行うこと

### ディレクトリ構造

本プロジェクトは以下構成を初期段階とする

```
$ pwd
/mnt/c/Users/shima/Desktop/学習アプリ開発_GeminiCLIデモ/articles

$ tree
.
├── README.md
├── assets
│   ├── *.png
│   ├── *.jpg
|   (省略)
├── master
│   ├── note-nomuragoro-1.xml
│   ├── sample.rss
│   └── 設計書 兼 AI コーディングルール定義書.md
├── output
├── poetry.lock
├── pyproject.toml
└── src
```

- AI は作ったソースコードは必ず src 以下に格納する
- AI はファイル出力をしたい場合は必ず output 以下に格納する
- 指定のディレクトリ以下にサブディレクトリを作成する事を許容する。
- ！デバッグ中は冪等性を担保するため、作業を始める前に上記以外のファイルやディレクトリは削除する
  - 更新タイミングによりファイル名の揺らぎに注意

### AI の自動実行権限

以下ディレクトリに適用する。それ以外は不可とする。
なお、上記での注意書きがある場合は制限が厳しいルールを優先すること

- src
  - ファイルの書き込み（作成と変更）
- output
  - ファイルの書き込みと削除
- master
  - ファイルの読み込み
- git コマンド
  - config user.name: `shimajima-eiji`
  - config user.email: `shimajima-eiji@live.jp`
  - add: 以下に指定するディレクトリ（サブディレクトリを含む）に限定する
    - /src
    - /output
  - commit
  - push

### 構築手順の留意点

- 環境構築時はなるべくホスト環境を汚さないようにすること。
  - WSL の場合は例外とするが、クロスプラットフォームを意識したいため可能な限り準拠しよう
- python は`poetry`で環境構築をする事
- node は`volta`で環境構築をする事

### プロセスのヘルスチェック

- あなたは負荷が高まってきたと感じた場合、作業完了時に設計者へ申し出ること
  - その際に、引継ぎ用のメモまたはプロンプトを作成する旨を設計者に打診し、格納場所や作成方針などを相談すること
- 設計者は AI から申告があった場合、当該プロセスの使用についてはそれ以上の継続をなるべく控え、次のスレッドに引き継げるようにすること

## 機能要件

### フルバックアップ(xml_backup.py)

一番最初に処理するもの。
xml ファイルを json_object.py のデータクラスにマッピングし、JSON 形式で保存する。
rss_backup.py と同じ json オブジェクトを生成するため、json_object.py のデータクラスを使う

比較的バグが少なく、出力結果も想定通りであることが多い。ほぼ問題ない。
多くの場合、変更をしなくていい事が多い

xml はファイルサイズが大きくなる傾向が強いため、1 ファイル 1 記事に分割する。
ファイル名は(guid).json とする。nxxxx...json のようになるはず。

### 差分バックアップは RSS(rss_backup.py)

RSS フィードを取得し、記事データを抽出する。
xml_backup.py と同じ json オブジェクトを生成するため、json_object.py のデータクラスを使う

- ※デバッグ中は sample.rss を読み込んで使うやり方を採用する。
  - 問題なければ本番環境である `https://note.com/nomuragoro/rss` からデータを取得する運用にする。
  - ！現在デバッグ中のため、`requests` を使ってはならない
  - ！現在デバッグ中のため、sample.rss から内容を取得するようにする。これは rss サーバーへのアタック行為にならないようにするためである

ファイル名は xml_backup.py と同じ記事であり、pub_date が新しい場合は上書きし、そうでない場合は当該ファイルの処理をスキップする
rss は guid が URL のため、nxxxx...json の部分を切り出して xml や fix と比較すること。

### json_object.py

JSON オブジェクトと各スクリプトファイルでやりとりするデータを保持するデータクラスオブジェクトを司る。
json オブジェクトを使って制御したいビジネスロジックはこのファイルに書いて、各バックアップスクリプトから呼び出して使用すること

#### json 例

- content に改行を含む場合は配列にすること
- img タグなど画像を含む場合は src の中身だけ取り出す事
- img タグの画像は assets ディレクトリからファイル名が一致するものに置き換えること
- 扉絵がある場合は
- pub_date は日付なのでゴールデンルールに準拠。リアルタイム性はない

```json
{
  "title": "ほげ",
  "pub_date": "2020-7-30 13:06",
  "guid": "n0cec4231d04d",
  "content": ["一行目", "二行目", "三行目"...],
  "status": "publish or draft"
}
```

以下の通りプレフィクスを設定する事

- xml*backup.py: `xml*`
- rss*backup.py: `rss*`
- fix*xml_rss.py: `fix*`

### verify_json_object.py

JSON オブジェクトの検証を行う
rss では post_id が空欄のため自動採番したり、xml と rss で同じ id でも publish_date が違うため更新がある可能性を考慮する必要がある。
また、既に存在するファイルの更新日が rss と同じか xml より古い場合は当該記事についての処理をスキップするロジックを含むこと。

### fix_xml_rss.py

xml（フルバックアップ） 版と rss（差分バックアップ） 版、fix 版（既存ファイル）との差分を取る
基本的に pub_date が最新のファイルを採用する。
pub_date が同一の場合、優先度は fix > xml > rss の順

処理が完了したものは fix_nxxx.json とし、xml 版と rss 版は削除すること

## コーディングトラブルシューティング

geminiCLI が頻発するミスと対策をまとめておく

- ファイルの末尾の行に`}`を書く癖があるようだ。該当するエラーメッセージを受け取った時、心当たりのあるファイルの末尾に不要な`}`が入っていないか確認しよう。
  - おそらく、python 以外の言語は大体`}`で終わる事が多いからだと思われる。java だとほぼ確定で`}`で終わるからだろう
- 設計書のやり方があなたのコーディングスタイルにあわず、何度も類似したバグが発生したり解決に時間がかかる場合は設計者と相談の上、方針を変えるようにする。具体的には、１回のタスクで同一ファイルを２回以上修正する事があれば作業を中断し、実装方針を相談すること
  - 修正すると言いながら「No changes detected.」であったり、あるいは特定のコードのコメントを書き換えただけで、実態としては何も変化がない修正を行う様子が見られるため
  - ファイルを変更した際、変更点の diff を毎回取って動作として変更があるか確認すること
  - 修正方針がわからない、または自信がない場合は直ちに作業を終了し、設計者と相談すること

## 設計者指南

- GeminiCLI は対話を 10 往復ぐらいすると考えが凝り固まってしまい大幅な軌道修正ができなくなるため、目に見えて精度が落ちたら新しいスレッドを使う事を検討すること
- 既存コードを修正させるより、思い切って新規ファイルを作らせた方が精度が上がる事が多いため、既存ファイルを手修正するつもりがなければ削除した方が良い
  - ただし、有事の際に差し戻せるように git commit は徹底させること

## 備考

- 本ファイルは作成中のため、ファイル名や場所を変更する可能性がある事に留意する事
- 設計
